const AnyChat=require('./anychatwxsdk'),ANYCHAT_DEFINE_TIMEOUT=30,ANYCHAT_HEARTBEAT_TIMEOUT=5e3,isObject=function(a){return'[object Object]'===Object.prototype.toString.call(a)},isString=function(a){return'[object String]'===Object.prototype.toString.call(a)},isArray=function(a){return'[object Array]'===Object.prototype.toString.call(a)},anychat=new AnyChat;function Connect(a){anychat.wss_url=a,anychat.signaling=wx.connectSocket({url:a,protocols:['anychat-protocol']}),anychat.signaling.onOpen(function(a){anychat.emit('websocket_open',a)}),anychat.signaling.onClose(function(a){anychat.emit('websocket_close',a)}),anychat.signaling.onError(function(a){anychat.emit('websocket_error',a)}),anychat.signaling.onMessage(function(a){anychat.emit('websocket_message',a)})}function Reconnect(a){if(!anychat.wss_url)return;anychat.OnSignalingError(a),clearInterval(anychat.reconnect_handle);let b=30;anychat.reconnect_handle=setInterval(function(){0<b?(anychat.signaling=wx.connectSocket({url:anychat.wss_url,protocols:['anychat-protocol']}),b-=5):(clearInterval(anychat.reconnect_handle),anychat.OnAnyChatLinkClose(a))},5e3)}function PreParseJSON(a){let b={};try{b=JSON.parse(a.data)}catch(a){console.error('JSON.parse error: ',a)}if('notify'==b.eventname&&anychat.signaling&&anychat.signaling){let a={eventname:'ack',ssrc:0,data:'',seq:b.seq};anychat.signaling&&1==anychat.signaling.readyState&&anychat.signaling.send({data:JSON.stringify(a)})}let c={};if(isString(b.data))try{c=JSON.parse(b.data)}catch(a){console.error('JSON.parse error: ',a)}else c=b.data;return c}anychat.on('websocket_connect',function(a){Connect(a)}),anychat.on('websocket_open',function(a){console.info('websocket_open',a),clearInterval(anychat.reconnect_handle);let b={cmdcode:'connect',version:anychat.ANYCHAT_SDK_VERSION,accesstype:3},c={eventname:'request',ssrc:0,data:{cmdcode:'heartbeat'}};anychat.heartbeat_handle=setInterval(function(){anychat.signaling&&1==anychat.signaling.readyState&&anychat.signaling.send({data:JSON.stringify(c)})},5000),anychat.emit('websocket_send',b)}),anychat.on('websocket_close',function(a){console.error('websocket_close',a),Reconnect(a)}),anychat.on('websocket_error',function(a){console.error('websocket_error',a),Reconnect(a)}),anychat.on('websocket_send',function(a){let b={eventname:'request',ssrc:0,data:a,seq:anychat.seq};anychat.signaling&&1==anychat.signaling.readyState&&anychat.signaling.send({data:JSON.stringify(b)}),anychat.seq++}),anychat.on('websocket_message',function(a){let b=PreParseJSON(a);try{let c=JSON.parse(a.data).eventname;'ack'!==c&&console.log('websocket_message: ',a,'pldata: ',b)}catch(a){console.error('JSON.parse(message_info.data).eventname: ',a)}let c='',d=b.errorcode||0,e=b.cmdcode||'',f=b.eventtype||0,g=b.userid||0,h=-1;switch(e){case'connect':anychat.OnAnyChatConnect(!d,d);break;case'login':anychat.userId=g,anychat.OnAnyChatLoginSystem(g,d);break;case'logout':anychat.wss_url='',anychat.signaling&&anychat.signaling.close(),anychat.signaling=null;break;case'enterroom':case'enterroomex':h=b.roomid,anychat.roomId=h,anychat.OnAnyChatEnterRoom(h,d);break;case'transbuffer':anychat.OnAnyChatTransBuffer(b.userid,b.jsonbuf,'');break;case'transbufferex':break;case'useratroom':let a=b.benter;if(1==a){anychat.userIdList.push(g),anychat.userIduserInfoMapping[g]={username:b.username,camerastate:b.camerastate,speakstate:b.speakstate,errorcode:b.errorcode};let a={cmdcode:'genericconsult',mediaid:'',type:1,jsonbuf:{type:1,requuid:`${g}-${anychat.roomId}-0`}};anychat.emit('websocket_send',a)}else 0==a&&(anychat.userIdList=anychat.userIdList.map(function(a){return a!=g}),anychat.userIduserInfoMappingBackup[g]=anychat.userIduserInfoMapping[g],delete anychat.userIduserInfoMapping[g]);anychat.OnAnyChatUserAtRoom(g,a);break;case'onlineuser':h=b.roomid;let f=[],i=[],j={};try{let a=JSON.parse(b.useridlist);f=a.useridlist||[],i=a.userlist||[]}catch(a){}let k={cmdcode:'genericconsult',mediaid:'',type:1,jsonbuf:{type:1,requuid:`${anychat.userId}-${anychat.roomId}-0`}};anychat.emit('websocket_send',k),i.forEach(function(a){let b={cmdcode:'genericconsult',mediaid:'',type:1,jsonbuf:{type:1,requuid:`${a.userid}-${anychat.roomId}-0`}};j[a.userid]=a,anychat.emit('websocket_send',b)});let l=f.length+1;anychat.userIduserInfoMapping=j,anychat.userIdList=f,anychat.OnAnyChatRoomOnlineUser(l,h);break;case'genericconsult':c=b.jsonbuf;let m,n;try{m=JSON.parse(c),n=JSON.parse(m.jsonbuf)}catch(a){console.error('genericconsult JSON parse error: ',a),m={},n={}}if(1==b.type){let a=n.requuid,b=n.mediaid,c=a&&a.split('-')||[],d=-c[1],e=2;c[0]&&(d=c[0]),-1==d||d==anychat.userId?(e=1,anychat.mediaId=b):anychat.userIduserInfoMapping[d].mediaId=b;let f={cmdcode:'genericconsult',mediaid:b,type:2,jsonbuf:{type:2,mediaid:b,userid:d,roomid:anychat.roomId,streamindex:0,mediatype:e}};anychat.emit('websocket_send',f)}else if(2==b.type){let a=n.rtmpurl,c=b.mediaid;if(c==anychat.mediaId)anychat.pusher_rtmpurl[anychat.userId]=a,anychat.pusher_rtmpurl[-1]=a;else for(let b in anychat.userIduserInfoMapping)if(anychat.userIduserInfoMapping[b].mediaId==c){anychat.userIduserInfoMapping[b].rtmpurl=a,anychat.puller_rtmpurl[b]=a;break}}console.info('anychat.pusher_rtmpurl,anychat.puller_rtmpurl: ',anychat.pusher_rtmpurl,anychat.puller_rtmpurl);break;case'objectevent':c=b.jsonbuf||'""';let o=b.objecttype,p=b.objectid,q=b.eventtype,r=b.param1||0,s=b.param2||0,t=b.param3||0,u=b.param4||0,v=b.strParam||'""';if(isString(c))try{m=JSON.parse(c)}catch(a){console.error('objectevent json parse error',a),m=null}0==q?4==o?anychat.areaIdareaInfoMapping[p]=m:5==o?anychat.queueIdqueueInfoMapping[p]=m:6==o?anychat.agentIdagentInfoMapping[p]=m:console.error('objectevent objecttype error, objecttype undefined.'):-1==q?4==o?anychat.realtimeAreaStatus[p]=m:5==o?anychat.realtimeQueueStatus[p]=m:6==o?anychat.realtimeAgentStatus[p]=m:console.error('objectevent objecttype error, objecttype undefined.'):(405==q&&(anychat.queueIdqueueInfoMapping={},anychat.realtimeQueueStatus={}),anychat.OnAnyChatObjectEvent(o,p,q,r,s,t,u,v));break;case'videocallevent':q=b.eventtype;let w=b.userid,x=b.flags,y=b.param,z=b.jsonbuf;anychat.OnAnyChatVideoCallEvent(q,w,d,x,y,z);break;default:}}),module.exports=anychat;